---
title: "White_Minority_Single_Multi"
output: html_document
---


```{r}
library(tidyverse)
library(dplyr)
library(plotly)

```

```{r}
washington <-read_csv('data/state_WA.csv')
head(washington, 5)

```

```{r}
#1. Total count if approved and denied loans by county_code, lei
wa_race<-washington%>%
  select(lei, county_code, census_tract, derived_race, action_taken, tract_population, tract_minority_population_percent)%>%
  mutate(approved=ifelse(action_taken == 1, 1, 0)) %>% group_by(lei, county_code, derived_race) %>%
  summarize(approved=sum(approved), denied=n()-sum(approved))
head(wa_race, 5)
```


```{r}
#2. Compute % of Loans Denied and Approved by county_code and lei
wa_total <- wa_race %>% group_by(lei, county_code) %>% summarize(total_applic=sum(approved)+sum(denied))
wa_result <- merge(wa_total, wa_race, by=c("lei","county_code")) %>% 
  mutate(pct_approval=100*approved/total_applic, pct_denied=100*denied/total_applic)
head(wa_result, 5)
```


```{r}
#3. Regroup Race by White and Minority by adding all non-White together
wa_minority <- wa_result %>% 
  mutate(bi_race=ifelse(derived_race=='White', 'White', 'Minority')) %>% 
  group_by(lei, county_code,bi_race) %>% summarise(approved=sum(approved), denied=sum(denied))
head(wa_minority, 5)
```


```{r}
#4. Compute pct_approved, denied for White and Monority Borrowers
wa_county <- wa_minority %>% group_by(lei, county_code) %>% summarise(total_applic=sum(approved) + sum(denied))
white_minority<-merge(wa_minority, wa_county, by=c("lei","county_code")) %>% 
mutate(pct_approval=100*approved/total_applic, pct_denied=100*denied/total_applic)

head(white_minority, 5)
```
```{r}
white_minority%>%nrow()
```


```{r}
#6. Tract_Minority_Pop_Pct
minority_per_tract<-washington%>%
   select(county_code, tract_minority_population_percent)%>%
   distinct(county_code, tract_minority_population_percent)%>%
   group_by(county_code)
   #distinct(county_code, tract_minority_population_percent)
minority_per_tract
```


```{r}
merge(white_minority, minority_per_tract, by="county_code") %>% nrow()

```
```{r}

```


```{r}
white_minority_one<-white_minority%>% 
  filter(county_code==53001 & lei=="01KWVG908KE7RKPTNP46") %>% 
  select(lei, bi_race, pct_approval) %>%
  pivot_wider(names_from = bi_race, values_from = pct_approval) %>% 
  replace(is.na(.), 0) 
white_minority_one

```


```{r}
white_minority_multi <-white_minority%>% 
  filter(county_code==53001 & lei %in% c("549300KM40FP4MSQU941", "7H6GLXDRUGQFU57RNE97",   "549300AG64NHILB7ZP05", "549300FGXN1K3HLB1R50",  "KB1H1DSPRFMYMCUFXT09")) %>% 
  select(lei, bi_race, pct_approval) %>%
  pivot_wider(names_from = bi_race, values_from = pct_approval) %>% 
  replace(is.na(.), 0) 
white_minority_multi
```

```{r}
white_minority_one<- white_minority_one %>% mutate(marker1=1)
white_minority_multi<-white_minority_multi %>% mutate(marker1=2)
```



```{r}
white_minority_combo<-rbind(white_minority_one, white_minority_multi)

white_minority_combo
```


```{r}
white_minority_combo_scat<-white_minority_combo%>%
  ggplot(aes(x=Minority, y=White, text=lei)) + 
  geom_point(alpha=0.8, size=3, colour=white_minority_combo$marker1) + 
  labs(title="Loans Approved to White and Minority Borrowers '%") + 
  theme(plot.title = element_text(size = 14, face= "bold")) + 
  labs(face= "bold") + theme(legend.position = "none")+
  labs(x="Minority Borrowers", y="White Borrowers", size=11, face="bold")
  ggplotly(white_minority_combo_scat, tooltip = "text")
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
