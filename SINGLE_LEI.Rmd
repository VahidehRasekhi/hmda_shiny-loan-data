---
title: "Single_LEI"
output: html_document
---


```{r}
library(tidyverse)
library(dplyr)
library(plotly)


```


```{r}
washington <-read_csv('data/state_WA.csv')
head(washington, 5)
```


```{r}
# Low Income Data and Chart
  by_income_count<-washington%>% 
    select(lei, county_code, census_tract, derived_race, action_taken, tract_population, tract_minority_population_percent, income,    
    ffiec_msa_md_median_family_income) %>% 
    mutate(approved=ifelse(action_taken == 1, 1, 0), low_income=ifelse(income<0.5*ffiec_msa_md_median_family_income, "low", "normal"))%>%     group_by(lei, county_code, low_income) %>% 
    summarize(approved=sum(approved), denied=n()-sum(approved))
by_income_count
```


```{r}
by_income_pct<-merge(wa_total, by_income_count, by=c("lei","county_code")) %>% 
    mutate(pct_approval=100*approved/total_applic, pct_denied=100*denied/total_applic) %>% 
    filter(low_income=="low")%>%group_by(county_code) %>% 
    mutate(avg_pct_approval_rate=mean(pct_approval)) %>% arrange(desc(total_applic))
by_income_pct
```


```{r}
test<-by_income_pct%>%
    pivot_wider(names_from = low_income, values_from = pct_approval, values_fill = list(value=0))%>%
    replace(is.na(.), 0) %>% 
    select(lei, low, avg_pct_approval_rate, total_applic, approved) %>% head(n=20)
test
```


```{r}
by_income_pct
```


```{r}
low_income1<-by_income_pct%>%
    pivot_wider(names_from = low_income, values_from = pct_approval, values_fill = list(value=0))%>%
    replace(is.na(.), 0)  %>% group_by(lei, county_code) %>% 
    filter(lei == "549300TUSRLWD8ETNR90" & county_code==53063	)%>%
    select(lei, low, avg_pct_approval_rate, total_applic, approved)

low_income1
```



```{r}
low_income_multi<-by_income_pct%>%
    pivot_wider(names_from = low_income, values_from = pct_approval, values_fill = list(value=0))%>%
    replace(is.na(.), 0) %>% group_by(lei, county_code) %>% 
   filter(lei %in% c("549300KM40FP4MSQU941", "7H6GLXDRUGQFU57RNE97",   "549300AG64NHILB7ZP05", "549300FGXN1K3HLB1R50",  "KB1H1DSPRFMYMCUFXT09") & county_code==53063) %>% 
    select(lei, low, avg_pct_approval_rate, total_applic, approved) %>% head(n=20)#%>% 
    
    #ggplot(aes(x=lei, y=low)) + geom_bar(stat="identity", fill="steelblue") + 
    #labs(title="Loans Approved to Low Income Borrowers '%") + theme(plot.title = element_text(size = 14, face= "bold")) + 
   # labs(y="pct %" , face= "bold")+ coord_flip()+
    #geom_hline(yintercept= by_income_pct$avg_pct_approval_rate[1]) 
  #ggplotly(low_income_multi, tooltip = c("total_applic", "approved"))


low_income_multi
```
```{r}
low_income1%>%nrow()
```
```{r}
low_income1<-low_income1%>%mutate(marker1= 1)
low_income_multi<-low_income_multi%>%mutate(marker1= 2)

low_income_combo<-rbind(low_income1, low_income_multi)
```


```{r}

low_income_combo %>% ggplot(aes(x=lei, y=low, fill = marker1)) + geom_bar(stat="identity") +  coord_flip() +
     geom_hline(yintercept= by_income_pct$avg_pct_approval_rate[1]) +
     labs(title="Loans Approved to Low Income Borrowers '%") + theme(plot.title = element_text(size = 14, face= "bold")) + 
     labs(y = "Low Income Borrowers %") + theme(legend.position = "none") #+
    # ggplotly(low_income_comparison, tooltip = "text")

```

```{r}
p<-low_income1%>%mutate(marker1= 1)
t<-low_income_multi%>%mutate(marker1= 2)

rbind(p, t)
#%>%group_by(lei)%>%summarise(n())
```

```{r}

rbind(p, t) %>% ggplot(aes(x=lei, y=low, fill = marker1)) + geom_bar(stat="identity") +  coord_flip() +
     geom_hline(yintercept= by_income_pct$avg_pct_approval_rate[1]) +
     labs(title="Loans Approved to Low Income Borrowers '%") + theme(plot.title = element_text(size = 14, face= "bold")) + 
     labs(y = "Low Income Borrowers %") + theme(legend.position = "none") #+
    # ggplotly(low_income_comparison, tooltip = "text")
```



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
